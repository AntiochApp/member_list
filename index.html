<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ì„±ë„ ë“±ë¡</title>

<style>
body{margin:0;padding:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#f5f5f5;}
.container{max-width:480px;margin:20px auto;padding:20px 16px;background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.08);}
h1{text-align:center;margin:0 0 16px;font-size:1.4rem;color:#333;cursor:pointer;}
.field{margin-bottom:14px;}
label{display:block;font-size:.9rem;margin-bottom:4px;color:#444;}
input,textarea{width:100%;padding:10px 12px;box-sizing:border-box;border:1px solid #ccc;border-radius:6px;font-size:.95rem;}
input:focus{outline:none;border-color:#4a90e2;box-shadow:0 0 0 2px rgba(74,144,226,.2);}
button{width:100%;padding:12px;font-size:1rem;border:none;border-radius:6px;background:#4a90e2;color:#fff;cursor:pointer;margin-top:6px;}
button:active{transform:scale(.99);}
.small-button{width:auto;font-size:.9rem;padding:6px 10px;margin-top:8px;}
.result{margin-top:12px;font-size:.9rem;text-align:center;}
.success{color:#1b8c3f;} .error{color:#d9534f;}
.small{text-align:center;color:#888;font-size:.8rem;}
.family-row{display:flex;gap:8px;margin-bottom:8px;}
.family-input{flex:1;}
.admin-row{display:flex;gap:8px;margin-bottom:8px;margin-top:4px;}
.admin-row input{flex:1;padding:8px 10px;}
.admin-row button{width:auto;padding:8px 12px;font-size:.9rem;}
.search-row{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;}
.search-row input{flex:1;padding:8px 10px;}
.table-wrapper{width:100%;overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:.8rem;min-width:700px;}
thead{background:#f0f0f0;} th,td{padding:6px;border-bottom:1px solid #e0e0e0;}
.photo-buttons{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;}
.photo-preview{text-align:center;margin-top:8px;}
.photo-preview img{max-width:100%;max-height:200px;border-radius:6px;border:1px solid #ddd;object-fit:contain;}
/* ì „í™”ë²ˆí˜¸ ë°€ë¦¼ í•´ê²° */
#phone{font-family:monospace;letter-spacing:.5px;}
</style>
</head>
<body>
<div class="container">

<h1 id="pageTitle">ê°œì¸ì •ë³´ ì…ë ¥</h1>

<form id="infoForm">
<input type="hidden" name="header_row" value="1">

<div class="field">
<label>ëª©ì¥/ìƒˆê°€ì¡±</label>
<input type="text" id="mokjang" name="ëª©ì¥">
</div>

<div class="field">
<label>ì´ë¦„</label>
<input type="text" id="name" name="ì´ë¦„" required>
</div>

<div class="field">
<label>ì „í™”ë²ˆí˜¸</label>
<input type="text" id="phone" name="ì „í™”ë²ˆí˜¸" placeholder="010-1234-5678" maxlength="13">
</div>

<div class="field">
<label>ì£¼ì†Œ</label>
<input type="text" id="address" name="ì£¼ì†Œ">
</div>

<div class="field">
<label>ì´ë©”ì¼</label>
<input type="email" id="email" name="ì´ë©”ì¼">
</div>

<div class="field">
  <label>ìƒë…„ì›”ì¼ (ì˜ˆ: 1990-05-21)</label>
  <input type="text" id="birth" name="ìƒë…„ì›”ì¼" placeholder="yyyy-mm-dd">
</div>

<div class="field">
<label>ì‚¬ì§„</label>
<div class="photo-buttons">
<button type="button" id="btnTakePhoto" class="small-button">ğŸ“· ì‚¬ì§„ ì´¬ì˜</button>
<button type="button" id="btnUploadPhoto" class="small-button">ğŸ–¼ ì‚¬ì§„ ì—…ë¡œë“œ</button>
</div>
<input type="file" id="photoCamera" accept="image/*" capture="environment" style="display:none;">
<input type="file" id="photoFile" accept="image/*" style="display:none;">
<div id="photoPreviewWrap" class="photo-preview" style="display:none;">
<img id="photoPreview">
</div>
</div>

<div class="field">
<label>ê°€ì¡± êµ¬ì„±ì›</label>
<div id="familyList">
<div class="family-row">
<input type="text" name="ê°€ì¡±ì´ë¦„[]" class="family-input" placeholder="ì´ë¦„">
<input type="text" name="ê°€ì¡±ê´€ê³„[]" class="family-input" placeholder="ê´€ê³„">
</div>
</div>
<button type="button" id="addFamily" class="small-button">+ êµ¬ì„±ì› ì¶”ê°€</button>
</div>

<button id="submitBtn">ì œì¶œí•˜ê¸°</button>
<div id="result" class="result"></div>
<div class="small">ëª¨ë“  ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</div>
<div class="small">ì‚¬ì§„ ì—…ë¡œë“œ ì‹œ 1-2ë¶„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
</form>

<hr>

<!-- ê´€ë¦¬ì -->
<div id="adminSection" style="display:none;">
<label>ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</label>
<div class="admin-row">
<input type="password" id="adminPassword" placeholder="ë¹„ë°€ë²ˆí˜¸">
<button id="adminLoginBtn">ê²€ìƒ‰ í™œì„±í™”</button>
</div>
<div id="adminStatus" class="admin-status"></div>
</div>

<div id="searchArea" style="display:none;">
<div class="search-row">
<input type="text" id="searchName" placeholder="ì´ë¦„" disabled>
<input type="text" id="searchMokjang" placeholder="ëª©ì¥" disabled>
</div>
<div class="search-row">
<button id="searchBtn" disabled>ê²€ìƒ‰</button>
<button id="refreshBtn" disabled>ì „ì²´ ìƒˆë¡œê³ ì¹¨</button>
</div>

<div id="listStatus" class="list-status">ê´€ë¦¬ì ëª¨ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤.</div>

<div id="tableWrapper" class="table-wrapper" style="display:none;">
<table>
<thead>
<tr>
<th>#</th><th>ëª©ì¥</th><th>ì´ë¦„</th><th>ì „í™”</th><th>ì£¼ì†Œ</th><th>ì´ë©”ì¼</th><th>ìƒì¼</th><th>ê°€ì¡±</th><th>ì‚¬ì§„</th>
</tr>
</thead>
<tbody id="data-body"></tbody>
</table>
</div>
</div>

</div>

<script>
// ê´€ë¦¬ì PW
const ADMIN_PASSWORD="Antioch19428";
const WEB_APP_URL="https://script.google.com/macros/s/AKfycbyN86SPJiewqgLf5RqrDd2OxdR4GDsX5IOzKi1vJEZ0ZDxDrd3mnVt5S7njOtPsRRBs7A/exec";

let isAdmin=false, allData=[];
let photoData="", photoMimeType="", photoFileName="";

const form=document.getElementById("infoForm"),
resultEl=document.getElementById("result"),
submitBtn=document.getElementById("submitBtn"),
familyList=document.getElementById("familyList"),
addFamily=document.getElementById("addFamily");

// ---------------- ì „í™”ë²ˆí˜¸ ìë™ í•˜ì´í”ˆ ----------------
document.getElementById("phone").addEventListener("input", e => {
  let v = e.target.value.replace(/[^0-9]/g, "");

  if (v.length <= 3) {
    e.target.value = v;
  } 
  else if (v.length <= 6) {
    e.target.value = v.slice(0,3) + "-" + v.slice(3);
  } 
  else {
    e.target.value = v.slice(0,3) + "-" + v.slice(3,6) + "-" + v.slice(6,10);
  }
});

// ---------------- ìƒë…„ì›”ì¼ ìë™ í•˜ì´í”ˆ (yyyy-mm-dd) ----------------
document.getElementById("birth").addEventListener("input", e => {
  let v = e.target.value.replace(/[^0-9]/g, "");

  if (v.length <= 4) {
    e.target.value = v; // yyyy
  }
  else if (v.length <= 6) {
    e.target.value = v.slice(0,4) + "-" + v.slice(4); // yyyy-mm
  }
  else {
    e.target.value = v.slice(0,4) + "-" + v.slice(4,6) + "-" + v.slice(6,8); // yyyy-mm-dd
  }
});
  
// ---------------- ë‚ ì§œ í¬ë§· ----------------
function formatDate(v){
if(!v) return "";
let d=new Date(v);
if(isNaN(d.getTime())) return v;
let y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,"0"),dd=String(d.getDate()).padStart(2,"0");
return `${y}-${m}-${dd}`;
}

// ---------------- ì œëª© 5ë²ˆ í´ë¦­ â†’ ê´€ë¦¬ì ----------------
let clk=0,timer=null;
document.getElementById("pageTitle").onclick=()=>{
clk++;
if(!timer) timer=setTimeout(()=>{clk=0;timer=null},1000);
if(clk>=5){
document.getElementById("adminSection").style.display="block";
document.getElementById("adminStatus").textContent="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
clk=0;clearTimeout(timer);timer=null;
}
};

// ---------------- ê´€ë¦¬ì ë¡œê·¸ì¸ ----------------
document.getElementById("adminLoginBtn").onclick=()=>{
let pw=document.getElementById("adminPassword").value.trim();
if(pw!==ADMIN_PASSWORD){
document.getElementById("adminStatus").textContent="ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜";
return;
}
isAdmin=true;
document.getElementById("adminStatus").textContent="ê´€ë¦¬ì ëª¨ë“œ ON";
document.getElementById("searchArea").style.display="block";
enableSearch(true);
loadData();
};

// ---------------- ê²€ìƒ‰ì°½ í™œì„±/ë¹„í™œì„± ----------------
function enableSearch(b){
document.getElementById("searchName").disabled=!b;
document.getElementById("searchMokjang").disabled=!b;
document.getElementById("searchBtn").disabled=!b;
document.getElementById("refreshBtn").disabled=!b;
document.getElementById("tableWrapper").style.display=b?"block":"none";
}

// ---------------- ê°€ì¡± ì¶”ê°€ ----------------
addFamily.onclick=()=>{
let r=document.createElement("div");
r.className="family-row";
r.innerHTML=`<input name="ê°€ì¡±ì´ë¦„[]" class="family-input" placeholder="ì´ë¦„">
<input name="ê°€ì¡±ê´€ê³„[]" class="family-input" placeholder="ê´€ê³„">`;
familyList.appendChild(r);
};

// ---------------- ì‚¬ì§„ ----------------
function handlePhotoFile(f){
if(!f)return;
photoMimeType=f.type;photoFileName=f.name;
const reader=new FileReader();
reader.onload=e=>{
photoData=e.target.result;
document.getElementById("photoPreview").src=photoData;
document.getElementById("photoPreviewWrap").style.display="block";
};
reader.readAsDataURL(f);
}
document.getElementById("btnTakePhoto").onclick=()=>document.getElementById("photoCamera").click();
document.getElementById("btnUploadPhoto").onclick=()=>document.getElementById("photoFile").click();
document.getElementById("photoCamera").onchange=e=>handlePhotoFile(e.target.files[0]);
document.getElementById("photoFile").onchange=e=>handlePhotoFile(e.target.files[0]);

// ---------------- ì œì¶œ ----------------
form.onsubmit=async e=>{
e.preventDefault();
submitBtn.disabled=true;submitBtn.textContent="ì „ì†¡ ì¤‘...";
resultEl.textContent="";

let fd=new FormData(form), famRows=document.querySelectorAll(".family-row");
let fam=[];
famRows.forEach(r=>{
let n=r.querySelector('input[name="ê°€ì¡±ì´ë¦„[]"]').value.trim();
let rel=r.querySelector('input[name="ê°€ì¡±ê´€ê³„[]"]').value.trim();
if(n&&rel) fam.push(`${n}(${rel})`);
});
const params=new URLSearchParams();
for(let [k,v] of fd.entries()){
if(k!=="ê°€ì¡±ì´ë¦„[]"&&k!=="ê°€ì¡±ê´€ê³„[]") params.append(k,v);
}
params.append("ê°€ì¡±ì •ë³´",fam.join(", "));
if(photoData){
params.append("photoData",photoData);
params.append("photoMimeType",photoMimeType);
params.append("photoFileName",photoFileName);
}

await fetch(WEB_APP_URL,{method:"POST",body:params,mode:"no-cors"});
resultEl.textContent="ì œì¶œ ì™„ë£Œ!";resultEl.classList.add("success");
form.reset();photoData="";document.getElementById("photoPreviewWrap").style.display="none";
submitBtn.disabled=false;submitBtn.textContent="ì œì¶œí•˜ê¸°";
if(isAdmin)loadData();
};

// ---------------- ì‹œíŠ¸ ë°ì´í„° ë¡œë“œ ----------------
async function loadData(){
document.getElementById("listStatus").textContent="ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
try{
let r=await fetch(WEB_APP_URL);
let d=await r.json();
allData=d; renderTable(d);
document.getElementById("listStatus").textContent=`ì´ ${d.length}ëª…`;
}catch(e){
document.getElementById("listStatus").textContent="ì˜¤ë¥˜ ë°œìƒ";
}
}

// ---------------- í…Œì´ë¸” ë Œë”ë§ ----------------
function renderTable(rows){
let tb=document.getElementById("data-body");
tb.innerHTML="";
rows.forEach((r,i)=>{
let tr=document.createElement("tr");
let photo=r["ì‚¬ì§„URL"]?`<a href="${r["ì‚¬ì§„URL"]}" target="_blank">ë³´ê¸°</a>`:"";
tr.innerHTML=`
<td>${i+1}</td>
<td>${r["ëª©ì¥"]||""}</td>
<td>${r["ì´ë¦„"]||""}</td>
<td>${r["ì „í™”ë²ˆí˜¸"]||""}</td>
<td>${r["ì£¼ì†Œ"]||""}</td>
<td>${r["ì´ë©”ì¼"]||""}</td>
<td>${formatDate(r["ìƒë…„ì›”ì¼"])}</td>
<td>${r["ê°€ì¡±ì •ë³´"]||""}</td>
<td>${photo}</td>`;
tb.appendChild(tr);
});
}

// ---------------- ê²€ìƒ‰ ê¸°ëŠ¥ ----------------
document.getElementById("searchBtn").onclick=()=>filter();
document.getElementById("refreshBtn").onclick=()=>loadData();

function filter(){
let n=document.getElementById("searchName").value.toLowerCase();
let m=document.getElementById("searchMokjang").value.toLowerCase();
let f=allData.filter(r=>{
let name=(r["ì´ë¦„"]||"").toLowerCase();
let mk=(r["ëª©ì¥"]||"").toLowerCase();
return (!n||name.includes(n)) && (!m||mk.includes(m));
});
renderTable(f);
document.getElementById("listStatus").textContent=`ê²€ìƒ‰ ê²°ê³¼ ${f.length}ëª…`;
}

// ì´ˆê¸°
enableSearch(false);
</script>

</body>
</html>


